<!-- docs/math/6-puzzle-generation.html -->
<section class="chapter" id="6-puzzle-generation">
    <h2 id="6-puzzle-generation">6. <ruby>問題生成<rt>もんだいせいせい</rt></ruby>と<ruby>一意性保証<rt>いちいせいほしょう</rt></ruby></h2>
    <div class="para">
        数独の問題生成における本質的な課題は、任意に配置された初期値の集合から出発するのではなく、あらかじめ整合的な完全解を構築したうえで、そこから与え値を削除しつつ常に一意解性を保持するという「逆問題」として定式化される点にある。完全盤 $\sigma$ はまず制約充足アルゴリズムによって生成され、これにより全てのセルが充足条件を満たすことが保証される。この完全盤から出発し、与え値の集合 $G \subseteq V$ を初期状態として保持する。すなわち最初は $G = V$ であり、全てのセルに値が埋め込まれている。生成アルゴリズムは $G$ から逐次的に要素を削除する操作を繰り返す。ただし重要なのは、削除のたびに「削除後の盤面が依然として一意解性を有するか」を必ず検証する点である。一意性が保持される場合に限り削除を確定し、保持されない場合には削除を棄却する。この反復過程によって、最終的に最小限の与え値を持つが一意解性を保つ問題が得られる。ここで核心となるのが一意性判定のアルゴリズムである。これは exact cover 問題に還元される。すなわち $729 \times 324$ の疎行列を構築し、729 行は「セル $(r,c)$ に数字 $d$ を配置する」という可能な割当を表し、324 列は「各セルに一つの値が入る」「各行に 1 から 9 が一度ずつ現れる」「各列に 1 から 9 が一度ずつ現れる」「各ボックスに 1 から 9 が一度ずつ現れる」という四種類の制約に対応する。この行列に対して Donald Knuth によって提案された Dancing Links (DLX) アルゴリズムを適用することで exact cover を効率的に探索できる。DLX は双方向連結リストによるカラム削除・復元操作を用いるため、組合せ爆発を伴う探索をきわめて効率的に進めることができる。一意性の確認においては「二解存在検査」として DLX を動作させる。すなわち、一つの解を見つけても探索を終了せず、第二の解を発見した時点で即座に停止する。この時点で盤面は非一意であると判定され、削除操作は棄却される。これにより「解が一つしか存在しない」という条件を高効率に検証することが可能になる。さらに生成過程においては、問題の難易度を制御する仕組みが求められる。完全にランダムに与え値を削除した場合、得られる問題の難易度は制御不能であり、ユーザにとって容易すぎたり、逆に過度に難解であったりすることがある。これを防ぐために確率的探索法を導入する。代表的なのは焼きなまし法であり、ここでは現在の問題の難易度 $\mathrm{Diff}$ と目標とする難易度 $\mathrm{Diff}^*$ との差を評価する。前回の難易度との差分を考慮に入れた上で、削除操作を受容するかどうかはメトロポリス基準に従って確率的に決定される。すなわち受容確率は

        $$p = \min \Biggl( 1,\ \exp \Biggl[ -\frac{ \bigl\lvert D - D^{\ast}\bigr\rvert - \bigl\lvert D_{\text{prev}} - D^{\ast}\bigr\rvert }{T} \Biggr] \Biggr)$$

        で与えられる。ここで $D$ は現在の難易度指標、 $D^*$ は目標難易度、 $D_{\text{prev}}$ は直前の難易度、 $T$ は温度パラメータである。反復の進行に伴い $T$ を徐々に減少させることで、局所的最適解に陥ることを避けつつ、大域的に所望の難易度へと収束させることができる。この確率的手続きを繰り返すことにより、生成される問題は常に一意解性を保持しながら、目標とする難易度に漸近する。したがって本方式によって得られる数独問題は、単に解を持つだけでなく、難易度が設計者の意図に適合するよう調整される。利用者はこれにより、容易な問題から高度に難解な問題まで、自らの学習目的や娯楽的要求に応じて選択・生成することが可能となる。
    </div>
</section>