<!-- docs/math/01-csp-formulation.html -->
<section class="chapter" id="01-csp-formulation">
    <h2 id="1-csp-formulation">1. 数独の数理的定式化：<ruby>制約充足問題<rt>せいやくじゅうそくもんだい</rt></ruby>としての構造と<ruby>一意解性<rt>いちいかいせい</rt></ruby></h2>
    <div class="para">
        <p>　数独は単純なパズルとして大衆的に親しまれているが、数学的に捉えるならば有限領域制約充足問題（Constraint Satisfaction Problem, CSP）の代表例として位置づけられる。この視点に立つと、数独は単なる娯楽にとどまらず、計算複雑性理論、抽象代数学、情報理論、さらには実用的なアルゴリズム設計に至るまで多岐にわたる学術的意義を持つことが明らかになる。有限 CSP は厳密には三つ組 $(V,\{D_v\}_{v\in V},C)$ によって与えられる。</p>
        <p><em>記法</em>：以後、<span class="math">$[9] := \{1,2,\dots,9\}$</span> と略記する。</p>
        <p>ここで $V$ は有限の変数集合であり、各 $v\in V$ には有限集合 $D_v$ が値域として割り当てられる。$C$ は制約の族であり、各制約 $c\in C$ はスコープ $\operatorname{scope}(c)=(v_1,\dots,v_k)$ と、その関係</p>
        <figure class="eq">$$R_c \subseteq \prod_{i=1}^k D_{v_i}$$</figure>
        <p>との組で記述される。解とは写像 $\sigma:V\to \bigsqcup_{v} D_v$ であって、任意の $c\in C$ に対して $(\sigma(v_1),\dots,\sigma(v_k))\in R_c$ を満たすものである。一般形では全変数に共通の値域 $D$ を採用するが、数独の場合も $D=\{1,\dots,9\}$ として統一できる。数独の具体化においては、変数集合を $V=\{x_{r,c}\mid r,c\in\{1,\dots,9\}\}$ と定める。制約族は行・列・各 $3\times 3$ ブロックごとに all-different 制約を課すことで表される。すなわち $\mathrm{AllDiff}(v_1,\dots,v_9)=\{(d_1,\dots,d_9)\in D^9 \mid \forall i\neq j,\ d_i\neq d_j\}$ を定義し、これを 27 系（9 行・9 列・9 ブロック）に適用する。与え値は単項制約 $x_{r,c}=d$ として追加され、全体の問題は $P=(V,D,C\cup G)$ と表される。充足可能性は</p>
        <figure class="eq">$$\mathsf{SAT}(P):=\exists \sigma:V\to D\ \forall c\in C\cup G,\ \sigma\models c$$</figure>
        <p>により定義される。ここで $\sigma \models c$ とは、$c$ のスコープ上への $\sigma$ の制限が関係 $R_c$ に属することを意味する。</p>
        <br>
        <p>　一意性の判定 $\mathsf{UNQ}(P)$ は、制約充足問題 $P$ に対して「ただ一つの解が存在するか否か」を問う判定問題である。形式的には $\mathsf{UNQ}(P) := (\exists \sigma : \sigma \models P)\ \wedge\ \neg\bigl(\exists \sigma_1 \neq \sigma_2 : \sigma_1,\sigma_2 \models P\bigr)$ と定義される。この定義が示すように、一意性は「少なくとも一つの解が存在する」という充足可能性と、「二つ以上の異なる解が存在しない」という排他性の二側面を同時に包含している。前者の「充足可能性」判定 $\exists\sigma:\sigma\models P$ は、任意の解 $\sigma$ を証拠として提示すれば多項式時間で検証できるため NP に属する。また後者に関しても、二つの異なる解 $\sigma_1,\sigma_2$ が与えられれば、それぞれが $P$ の解であることを確認するのは多項式時間で可能である。したがって「相異なる二解の存在」言語も NP に属し、その否定は coNP に帰属する。以上により $\mathsf{UNQ}(P)$ は NP 言語と coNP 言語の交わりとして表現できる。すなわち</p>
        <figure class="eq">$$\mathsf{UNQ}(P) \in \mathrm{DP}, \\ \mathrm{DP}=\{\,L_1\cap L_2\mid L_1\in\mathrm{NP},\;L_2\in\mathrm{coNP}\,\}$$</figure>
        <p>である。DP は Papadimitriou によって導入された複雑性クラスであり、NP∩coNP と一致するわけではなく、それを真に含む交わり型のクラスである点に注意を要する。一般化された数独問題については DP 完全性が知られているが（例：<a href="#ref-yato-seta-2003">Yato–Seta, 2003</a>）、ここでは完全性の議論には立ち入らず、帰属に関する説明にとどめる。</p>
        <br>
        <p>　ここで強調すべきは、$\mathsf{UNQ}(P)$ の DP 帰属は 言語としての帰属 であり、特定のアルゴリズムや実装戦略に依存しないという点である。すなわち、探索の順序選択、ヒューリスティクスの設計、候補削減規則の適用順序などの実務的側面は、問題の複雑性クラスとしての本質的地位には影響を与えない。帰属の主張は、あくまでチューリング機械上での言語認識の観点から成立する理論的命題であり、個別のアルゴリズム設計や実行時間の漸近的挙動と混同されるべきではない。この言語的帰属に直ちに付随するのは、候補集合の数理構造の厳密な分析である。すなわち、各セル $(r,c)$ に割り当てられる候補集合 $S_{r,c}\subseteq D$ を座標ごとに積み重ねた空間 $\mathcal L=\mathcal P(D)^V$ を考える。この空間においては、通常の包含順序ではなく、その反対である反包含順序を導入するのが自然である。</p>
        <br>
        <p>　すなわち $X \sqsubseteq Y \stackrel{\text{def}}{\iff} X \supseteq Y$ と定める。この反包含順序の下では、候補削減作用素は膨張的（inflationary）写像として振る舞う。ここで「膨張的」とは、順序に従えば常に $X \sqsubseteq F(X)$ が成り立つことを意味し、直観的には「候補集合を縮小させる操作」が順序関係上は拡張的に見えることを表す。実際、all-different 制約や与え値から誘導される候補削減作用素 $F:\mathcal{L}\to\mathcal{L}$ は、任意の $X,Y\in\mathcal{L}$ に対して
        <figure class="eq">$$X \sqsubseteq Y \;\Rightarrow\; F(X)\sqsubseteq F(Y), \\ X \sqsubseteq F(X)$$</figure>
        <p>を満たす単調かつ膨張的な作用素として定義できる。Knaster–Tarski の不動点定理（例：<a href="#ref-tarski-1955">Tarski, 1955</a>）によれば、完備束上の単調写像は必ず最小不動点 $\operatorname{lfp}(F)$ と最大不動点 $\operatorname{gfp}(F)$ を持つ。数独の候補削減においては前者が意味を持つ。さらに $(\mathcal L, \sqsubseteq)$ は有限格子であるため、降鎖条件（descending chain condition）が自動的に成立し、Kleene 反復（例：<a href="#ref-kleene-1952">Kleene, 1952</a>）</p>
        <figure class="eq">$$X_0=\bot,\qquad X_{i+1}=F(X_i)$$</figure>
        <p>を下限元 $\bot$（すなわち「各セルの候補が最大集合 $D$」）から開始すれば、ある有限の $N$ に対して</p>
        <figure class="eq">$$X_N = X_{N+1} = \operatorname{lfp}(F)$$</figure>
        <p>が成立し、有限ステップで必ず最小不動点に到達する。すなわち、Knaster–Tarski が存在を保証する不動点を、Kleene 反復は実際に構成的に与えることになる。この収束性は同期的な一斉更新に限らず、非同期反復（chaotic iteration）においても保持される。すなわち、写像族が単調であり格子が有限である限り、局所的な更新をワークリスト方式で行っても、最終的には必ず $\operatorname{lfp}(F)$ に到達する。</p>
        <br>
        <p>　この束論的保証を数独解法に適用すれば、更新の生じたセルの近傍三系（同じ行・列・ブロック）をワークリストに再投入することで効率的な昇鎖を実現できる。数独の制約グラフでは各セルが約 20 の近傍を持ち、全体の辺数は $e \approx 810$ 程度にすぎない。また候補値域 $d=9$ は定数であるため、更新操作の計算コストは理論的には「更新回数に比例する定数倍」と評価できる。従って候補削減の収束過程は、計算複雑性理論上の DP 帰属と矛盾することなく、束論に基づく安定性保証を伴い効率的に実装可能であることが明らかになる。</p>
        <br>
        <p>　弧整合（AC-3, AC-2001）や一般化整合（GAC）は、関係の射影・前像に基づく具体的な $F$ の実現であり、その健全性は「削除される候補は現行の制約下で支持の無い値のみ」という性質により保証され、完全性は「$\operatorname{lfp}(F)$ 到達後は、局所的な意味でこれ以上削減できない」こととして特徴づけられる。計算量の見積もりにおいて、AC-3 はエッジ数 $e$ 、領域サイズ $d=|D|$ に対し $O(ed^3)$、改良型の AC-2001 は $O(ed^2)$ の振る舞いを示すと解析されるが、数独では $d=9$ が定数であるため、実務上はセル数 $81$ と制約の疎密構造が支配的となる。さらに all-different に対してはマッチング理論に基づく強整合化（Regin のアルゴリズム）により、集合被覆の観点から候補削除が可能であるが、これも作用素 $F$ の特殊化として理解できる。</p>
        <br>
        <p>　候補格子の縮約を定量化するために情報理論的尺度を導入する。独立一様近似の下で各セルに対し $H(x_{r,c})=\log_2 |S_{r,c}|$ を定義し、盤面の不確実性を $H(P)=\sum_{r,c} \log |S_{r,c}|$ と置く。これは真の結合エントロピーに対する上界的ヒューリスティクであり、相関を無視するという近似を内在するものの、縮約作用素の単調性から $\Delta H\le 0$ が常に成り立つ。すなわち、候補削減 $F$ は各セルの候補数 $|S_{r,c}|$ を減少させる方向にしか作用しないため、全体の和 $H(P)$ も必ず単調非増加する。</p>
        <br>
        <p>　探索においては、候補最小原理（MRV）$(r^*,c^*)\in\operatorname{argmin}_{(r,c)} |S_{r,c}|$ を基本規準とし、同点を weighted degree（各制約の失敗履歴に基づく重み $w(c)$ を用いて $\sum_{c\ni (r,c)} w(c)$ を最大化する）や、仮置き後の局所伝播により得られる期待 $-\Delta H$ を優先することで整序する。ここで $-\Delta H$ をより素直に確率的利得として扱うなら、各セル候補に一様事前
        <figure class="eq">$$p(d) = \frac{1}{\lvert S_{r,c}\rvert}$$</figure>
        <p>を置き、仮置き後の候補サイズから事後 $q(d)$ を近似して</p>
        <figure class="eq">$$\mathrm{IG}(d) = \log |S_{r,c}| - \sum_{(r',c')} \log |S'_{r',c'}|$$</figure>
        <p>を比較すればよい。分布としての挙動を強調するなら、微小平滑 $\epsilon>0$ による正則化を加えた</p>
        <figure class="eq">$$\mathrm{KL}(p\parallel q)=\sum_{d\in D} p(d)\log\frac{p(d)}{q(d)+\epsilon}$$</figure>
        <p>を用いて推論規則の証拠強度を測ることも可能である。もっとも、これらは厳密な意味での統計モデル化ではなく、縮約量を秩序化するための理論的に一貫した近似的序関係を与えるものとして解すべきである。</p>
        <br>
        <p>　計算複雑性の観点では、一般化された $n^2\times n^2$ 数独の充足可能性が NP 完全であることは標準的な結果であり、CNF SAT もしくはグラフ彩色からの多項式時間帰着によって示される。CNF への符号化では、命題変数 $X_{r,c,d}$ を「セル $(r,c)$ に値 $d$ を置く」ことに対応させると、変数は $9\cdot 9\cdot 9=729$ 個となる。各セルちょうど一つの値という制約は</p>
        <figure class="eq">$$\displaystyle \bigvee_{d=1}^{9} X_{r,c,d} \;\land\; \bigwedge_{\substack{d,d'\in[9]\\ d\neq d'}}\!\bigl(\neg X_{r,c,d}\vee \neg X_{r,c,d'}\bigr)$$</figure>
        <p>により与えられ、行・列・ブロックごとの all-different は値ごとに</p>
        <figure class="eq">$$ \displaystyle \begin{aligned} &\bigwedge_{r\in[9]}\ \bigwedge_{\substack{c,c'\in[9]\\ c\neq c'}}\!\bigl(\neg X_{r,c,d}\vee \neg X_{r,c',d}\bigr),\\ &\bigwedge_{c\in[9]}\ \bigwedge_{\substack{r,r'\in[9]\\ r\neq r'}}\!\bigl(\neg X_{r,c,d}\vee \neg X_{r',c,d}\bigr),\\ &\bigwedge_{\,\mathcal B}\ \bigwedge_{\substack{(r,c),(r',c')\in \mathcal B\\ (r,c)\neq (r',c')}}\!\bigl(\neg X_{r,c,d}\vee \neg X_{r',c',d}\bigr). \end{aligned}$$</figure>
        <p>で与えられる。節数の増加は定数倍を含めても $O(9^3)$ の範囲に収まり、標準盤面でも数万節程度に過ぎない。たとえば各セルについての「少なくとも一つ（ALO）」は 81 節、続く「一つに限定（AMO）」は $81\times 36 = 2,916$ 節を生み出す。さらに行・列・ブロックごとに値 $d$ を重複なく割り当てる制約を加えると、全体でおよそ 1.2 万節規模に達する。</p>
        <br>
        <p>　CNF 符号化の正当性は、整合性（解があれば CNF を充足）と完全性（CNF のモデルから数独の解が復元可能）によって二方向で確認される。Exact Cover への還元は別の等価定式化であり、行列 $A\in\{0,1\}^{729\times 324}$ を、行が候補 $(r,c,d)$、列が 4 種類の制約</p>
        <figure class="eq">$$\text{cell}_{r,c},\quad \text{row}_{r,d},\quad \text{col}_{c,d},\quad \text{box}_{\beta,d}$$</figure>
        <p>で表され、ブロック番号 $b$ はセル座標 $(r,c)$ から $\beta=3\lfloor(r-1)/3\rfloor+\lfloor(c-1)/3\rfloor+1$ によって一意に定まる。この規則に従って行列を構成し、該当する制約列に 1 を立てると、問題は「各列をちょうど一度ずつ被覆する行集合」を求める Exact Cover として定式化される。Algorithm X はこの被覆集合を探索する手続きであり、Dancing Links（DLX）はその効率的な連結リスト実装である。正当性は、選ばれた行集合が正確に一つの値割当と 4 種の制約充足を同時に与えることから直ちに従う。さらに列選択における「最小 1 の列」を優先するヒューリスティクは探索木の分岐係数を平均的に著しく低減し、この点で候補格子側の MRV（Minimum Remaining Values）ヒューリスティクと概念的に対応する。すなわち MRV が「選択肢の稀少なセル」を選ぶのに対し、DLX の列最小選択は「支持の稀少な制約列」を選ぶのであり、両者はいずれも希薄性という同一の構造特性を異なる表現系で測っているに他ならない。</p>
        <br>
        <p>　一意性検証に関しては、$\mathsf{UNQ}(P)$ の定義が示す通り存在と非存在の複合であるため、実装上は「一解発見後、別解を一つ見つけ次第停止する」戦略が自然である。これは誤陰性を生まない（別解が存在すれば必ず見つけた時点で非一意と結論できる）が、誤陽性を避けるには「発見されなかった」ことの側にも証明的重みが必要であり、探索戦略は有限であること、枝刈りは健全であることが条件となる。DLX の場合、列カバーの全探索は有限であり、特定の枝刈り（例えば一意性検査に不要な対称性の打ち切り）を導入しない限り、探索空間の完全走査により非存在が保証される。候補格子側の探索では、局所推論の健全性（削除は常に安全）とバックトラックの完全性（全割当への網羅）により、同様に非存在の主張が裏付けられる。</p>
        <br>
        <p>　代数学的視点は、完成盤の計数や生成過程における重複排除において決定的な役割を果たす。数独盤面に保存される対称性としては、数字置換群 $S_9$、行や列のバンド・スタック単位の置換、各バンド内の行置換および各スタック内の列置換、さらに正方形の回転・反転を表す二面体群 $D_4$ が挙げられる。これらを総合した群 $G$ が盤面集合 $\Omega$ に作用するとき、群作用は軌道分解</p>
        <figure class="eq">$$\Omega = \bigsqcup_i G \cdot \omega_i$$</figure>
        <p>を与える。このとき各軌道の大きさは安定化群 $G_\omega$ を用いて</p>
        <figure class="eq">$$|G \cdot \omega| = \frac{|G|}{|G_\omega|}$$</figure>
        <p>と表され、計数と同型排除の双方に利用できる。さらに、群作用では Burnside の補題</p>
        <figure class="eq">$$|\Omega/G| = \frac{1}{|G|} \sum_{g \in G} |\operatorname{Fix}(g)|$$</figure>
        <p>により、群作用の下での同型類の数が「固定される盤面の個数」の平均として評価できる。実務的には、生成段階で代表元規約（例えば辞書式最小の行列形）を課すことで、探索木における同型分枝を未然に抑圧することが有効である。</p>
        <br>
        <p>　難易度の定量化に関しては、単なる手数や分岐回数を超えて、縮約過程と探索過程の双方を統合する汎関数として定義するのが自然である。情報理論的観点からは、時間を離散化して $t=0,1,\dots,T-1$ としたとき、
        <figure class="eq">$$\mathcal D(P) = \sum_{t=0}^{T-1} \bigl(-\Delta H_t\bigr) + \lambda \sum_{b \in \mathcal T}\bigl(1+\mu\,\mathrm{depth}(b)\bigr)$$</figure>
        <p>と表せる。ここで $-\Delta H_t$ は時刻 $t$ における情報量減少（候補集合の対数サイズの減少）を表し、$B$ は探索分岐の集合、$\mathrm{depth}(b)$ は分岐 $b$ の深さである。定数 $\lambda,\mu>0$ は単位系を整えるための重みであり、推論が停滞する局面では探索コストが支配的に、推論が強力に働く局面では $-\Delta H_t$ が支配的となる。</p>
        <br>
        <p>　経験的観察によれば、$-\Delta H_t$ の寄与はしばしばサブモジュラ関数に類似した漸減性を示す。すなわち、手筋の追加適用による限界効用は逓減する傾向があり、この性質はサブモジュラ最適化における貪欲法の近似保証とアナロジーを持つ。従って、候補削減規則を貪欲的に適用する戦略が実際に高品質の近似解法を与えるという経験則には、理論的根拠が付与される。</p>
        <br>
        <p>　Python による計算的実現は、上述の理論をそのまま具体化する。候補集合を 9 ビット整数 $C_{r,c}\in\{0,\dots,2^9-1\}$ で表現し、ビット番号は $d\in\{1,\dots,9\}$ を 1-based として $\mathrm{mask}(d)=1\ll (d-1)$ を採る。行・列・ブロックの使用済み集合 $U^\mathrm{row}_r,U^\mathrm{col}_c,U^\mathrm{box}_b$ をビット和で維持し、更新則</p>
        <figure class="eq">$$C_{r,c}\leftarrow C_{r,c}\ \&\ \neg\Bigl(U^\mathrm{row}_r\ \vert\ U^\mathrm{col}_c\ \vert\ U^\mathrm{box}_b\Bigr)$$</figure>
        <p>により禁止値を排除する。候補数は $\mathrm{popcount}(C_{r,c})$ により定数時間で得られる。Kleene 反復は、固定長のキューで「変化したセルの近傍三系」を再処理することで実現でき、停止は有限束上の降鎖条件から自動的に保証される。探索では MRV により $\min \mathrm{popcount}$ のセルを選び、同数の場合には仮置き → 局所伝播 → $-\Delta H$ ないし dom/wdeg の増加が最大のものを優先する。ここで dom/wdeg は、失敗した制約に重みを加算し、以後その制約に関与する変数が優先されるようにする経験的にも強力な規準である。DLX への切替は、候補格子が不動点に達し、かつ未確定セルが残る局面で行うのが自然で、候補稀少性の極端な列（値・行・列・ブロックのいずれか）から探索することで分岐係数を抑える。ユニット伝播や二項節学習に相当する「ノーグッド学習」は、候補格子側では禁則パターンとして、DLX 側では部分的列被覆の不能集合として蓄積でき、いずれも探索の重複を抑止する。</p>
        <br>
        <p>　生成問題においては、完全盤 $\sigma$ を乱択により獲得し、与え値集合 $G\subseteq V$ を初期化した後、$G$ から要素を一つずつ候補削除して一意性が保持される場合に限り削除を確定する。ここでの一意性検証は、DLX により一解を見つけた後、二解目の探索を行い、見つかればただちに「非一意」と結論し、見つからなければ全探索の完走によって「一意」を主張するという、理論的にも実装的にも節度ある手順で足りる。難易度を制御した問題生成を行うには、削除の各ステップで Kleene 反復がもたらす情報圧縮 $-\Delta H$ の積算や、のちの探索で消費される分岐コストの予測値を合成したメタロス $\Phi(G)$ を設計し、焼きなましや確率的勾配法により所望の $\Phi$ に近づくよう与え値を選別する。群作用の利用により、与え値集合 $G$ の同型を事前に同値類へ商取りすることで、冗長な候補を塊ごと棄却でき、探索空間は指数的に圧縮される。最後に、数独が「単純さ」と「可圧縮性」の緊張を内蔵する数学的対象であることを強調する。完成盤の総数は天文学的であり探索空間 $9^{81}$ は桁外れであるにもかかわらず、候補格子上の単調縮約と、情報利得を最大化する探索規準の組合せは、与え値の少ない局面からでも短い計算で大きなエントロピーを消去する。ここで働いているのは、完備束上の不動点理論、群作用と同値類の商、Exact Cover による厳密離散最適化、そして情報理論的尺度による序付けであり、これらが一体となって「手筋」と呼ばれる人間のヒューリスティクを理論の言葉で再解釈する。解が一意であるとは、Exact Cover の観点では列選択の軌道がただ一つの被覆に収束すること、情報理論の観点では $H(P)\to 0$ が唯一の経路で達成されること、格子論の観点では $\operatorname{lfp}(F)$ の近傍が単一の極小要素に収束することに等価である。かくして数独は、遊戯と学理の二重性を統合し、有限数学の深層を可視化する作動的理論模型として、研究書の対象に相応しい厳格さと豊穣さを兼ね備えている。</p>
    </div>
</section>