/* ========== KaTeX & 数式画像 ========== */
.katex {
    color: inherit;
}

.katex .mop,
.katex .op-symbol {
    font-size: 1.05em;
    line-height: 1.1;
}

/* --- 数式ブロック：縦スクロール完全抑止 + スクロール連鎖の遮断 --- */
.katex-display,
figure.eq {
    /* 幅関連（既存） */
    max-width: 100%;
    white-space: normal !important;
    word-break: break-word;
    line-break: anywhere;

    /* スクロール制御 */
    overflow-x: hidden;
    overflow-y: hidden;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: auto;
    scrollbar-width: none;
}

.katex-display::-webkit-scrollbar,
figure.eq::-webkit-scrollbar {
    display: none;
}

/* Chrome/Safari/Edge */

.katex-display {
    margin: 1.1em 0;
}


.katex-display>.katex,
figure.eq .katex-display>.katex {
    display: inline-block;
    max-inline-size: 100%;
    white-space: normal !important;
    contain: layout paint;
}

figure.eq {
    margin: 1.2em auto;
    text-align: center;
    padding-inline: 4px;
}

figure.eq>.katex-display,
figure.eq>script[type="math/tex; mode=display"] {
    margin: 0 auto;
    max-inline-size: 100%;
}

figure.eq .katex-display>.katex {
    display: inline-block;
    max-inline-size: 100%;
    white-space: normal !important;
}

/* インライン/ブロック画像数式ユーティリティ */
.tex-img {
    display: inline-block;
    height: 1em;
    width: auto;
    vertical-align: -0.15em;
    line-height: 1;
}

.tex-block {
    display: block;
    margin: 0.5em auto;
    height: auto;
    max-width: min(100%, 720px);
    width: auto;
}

/* ブロック表示にしたい場合は <img class="tex-img block"> を指定 */
.tex-img.block {
    display: block;
    margin: 1rem auto;
    height: auto;
    max-width: min(100%, 720px);
    width: auto;
}

/* .math-* コンテナ（picture/img どちらでもOK） */
.math-block {
    display: block;
    margin: 1rem auto;
    text-align: center;
    max-width: 100%;
}

.math-block picture {
    display: inline-block;
    max-width: 100%;
}

.math-block img {
    max-width: min(100%, 720px);
    width: auto;
    height: auto;
}

.math-inline {
    display: inline-block;
    max-width: 100%;
    vertical-align: -0.2em;
}

.math-inline picture,
.math-inline img {
    display: inline-block;
    max-inline-size: 100%;
    height: 1.05em;
    width: auto;
}

.math-inline img {
    vertical-align: -0.15em;
}

/* ====== KaTeX: モバイル強化（スマホ限定: 幅<=640px & hover不可 & 粗いポインタ）====== */
@media screen and (width <=640px) and (hover: none) and (pointer: coarse) {

    /* --- 0) 全体の土台（既存調整の強化） --- */
    .katex .mbin,
    .katex .mrel {
        font-size: 1.14em;
        line-height: 1.06;
    }

    .katex .delimsizing.size1,
    .katex .delimsizing.size2,
    .katex .delimsizing.size3,
    .katex .delimsizing.size4 {
        font-size: 1.24em;
        line-height: 1.06;
    }

    .katex .sqrt .sqrt-sign {
        transform: scaleY(1.16);
        transform-origin: left bottom;
    }

    .katex .mfrac .frac-line {
        border-top-width: 2.2px;
    }

    .katex .mfrac .numerator,
    .katex .mfrac .denominator {
        line-height: 1.28;
    }

    .katex .scriptstyle {
        font-size: 1.00em;
    }

    .katex .scriptscriptstyle {
        font-size: 0.92em;
    }

    /* --- 1) 大型演算子のベース拡大（Σ, ⨆, ⋀, ⋁ を含む） --- */
    /* inline 数式 */
    .katex-inline .op-symbol.large-op,
    .katex-inline .mop>.op-symbol {
        font-size: 1.20em !important;
        line-height: 1.08;
    }

    /* display 数式（ブロック） */
    .katex-display .op-symbol.large-op,
    .katex-display .mop>.op-symbol {
        font-size: 1.20em !important;
        line-height: 1.08;
        vertical-align: -0.02em;
    }

    /* --- 2) limits（上下添字）の詰まり解消 --- */
    .katex .op-limits>.vlist-t,
    .katex .op-limits>.vlist-r {
        line-height: 1.34;
    }

    /* --- 3) 演算子周辺の最終微調整 --- */
    .katex .large-op+.mbin,
    .katex .large-op+.mrel {
        margin-left: 0.02em;
    }
}

/* iOS Safari でさらに念押し */
@supports (-webkit-touch-callout: none) {
    @media screen and (width <=640px) and (hover: none) and (pointer: coarse) {

        /* --- 0) 全体の土台（既存調整の強化） --- */
        .katex .mbin,
        .katex .mrel {
            font-size: 1.14em;
            line-height: 1.06;
        }

        .katex .delimsizing.size1,
        .katex .delimsizing.size2,
        .katex .delimsizing.size3,
        .katex .delimsizing.size4 {
            font-size: 1.24em;
            line-height: 1.06;
        }

        .katex .sqrt .sqrt-sign {
            transform: scaleY(1.16);
            transform-origin: left bottom;
        }

        .katex .mfrac .frac-line {
            border-top-width: 2.2px;
        }

        .katex .mfrac .numerator,
        .katex .mfrac .denominator {
            line-height: 1.28;
        }

        .katex .scriptstyle {
            font-size: 1.00em;
        }

        .katex .scriptscriptstyle {
            font-size: 0.92em;
        }

        /* --- 1) 大型演算子のベース拡大（Σ, ⨆, ⋀, ⋁ を含む） --- */
        /* inline 数式 */
        .katex-inline .op-symbol.large-op,
        .katex-inline .mop>.op-symbol {
            font-size: 1.20em !important;
            line-height: 1.08;
        }

        /* display 数式（ブロック） */
        .katex-display .op-symbol.large-op,
        .katex-display .mop>.op-symbol {
            font-size: 1.20em !important;
            line-height: 1.08;
            vertical-align: -0.02em;
        }

        /* --- 2) limits（上下添字）の詰まり解消 --- */
        .katex .op-limits>.vlist-t,
        .katex .op-limits>.vlist-r {
            line-height: 1.34;
        }

        /* --- 3) 演算子周辺の最終微調整 --- */
        .katex .large-op+.mbin,
        .katex .large-op+.mrel {
            margin-left: 0.02em;
        }
    }
}
